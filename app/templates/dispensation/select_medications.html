{% extends "base.html" %}

{% block title %}Selecionar Medicamentos - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('main.dispensation_index') }}">Dispensação</a>
                    </li>
                    <li class="breadcrumb-item active">Selecionar Medicamentos</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">
                <i class="fas fa-pills me-2 text-primary"></i>
                Dispensação para {{ patient.full_name }}
            </h1>
            <div class="alert alert-info mt-2">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Controle Universal:</strong> Todos os medicamentos requerem configuração de intervalo de dispensação.
            </div>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('main.dispensation_index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Voltar
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Informações do Paciente -->
        <div class="col-xl-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user me-2"></i>Dados do Paciente
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="avatar-lg bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3">
                            {{ patient.full_name[0].upper() }}
                        </div>
                        <div>
                            <h6 class="mb-0">{{ patient.full_name }}</h6>
                            <small class="text-muted">{{ patient.age }} anos</small>
                        </div>
                    </div>
                    
                    <div class="row g-2 text-sm">
                        <div class="col-12">
                            <strong>CPF:</strong> {{ patient.formatted_cpf }}
                        </div>
                        {% if patient.cns %}
                        <div class="col-12">
                            <strong>CNS:</strong> {{ patient.formatted_cns }}
                        </div>
                        {% endif %}
                        {% if patient.primary_phone %}
                        <div class="col-12">
                            <strong>Telefone:</strong> {{ patient.formatted_phone }}
                        </div>
                        {% endif %}
                        {% if patient.address %}
                        <div class="col-12">
                            <strong>Endereço:</strong> {{ patient.full_address }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ✅ CONTROLES DE INTERVALO ATIVOS -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-clock me-2 text-warning"></i>Controles de Intervalo Ativos
                    </h6>
                </div>
                <div class="card-body p-0" id="activeControlsList">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <p class="mb-0">Carregando controles...</p>
                    </div>
                </div>
            </div>

            <!-- Carrinho de Medicamentos -->
            <div class="card" id="medicationCart">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Medicamentos Selecionados
                        <span class="badge bg-primary ms-2" id="cartCount">0</span>
                    </h6>
                </div>
                <div class="card-body" id="cartItems">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                        <p class="mb-0">Nenhum medicamento selecionado</p>
                        <small>Clique no botão + para adicionar medicamentos</small>
                    </div>
                </div>
                <div class="card-footer" id="cartFooter" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Total:</strong>
                        <strong id="cartTotal">R$ 0,00</strong>
                    </div>
                    <button type="button" class="btn btn-success w-100" id="proceedToConfiguration">
                        <i class="fas fa-cog me-1"></i>Configurar Intervalos
                    </button>
                </div>
            </div>
        </div>

        <!-- ✅ BUSCA DE MEDICAMENTOS -->
        <div class="col-xl-8">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-search me-2"></i>Buscar Medicamentos
                            </h5>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- ✅ BARRA DE BUSCA -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" id="medicationSearch" class="form-control form-control-lg" 
                                       placeholder="Digite o nome do medicamento para buscar..."
                                       autocomplete="off">
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Digite pelo menos 3 caracteres para buscar
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select id="medicationType" class="form-select">
                                <option value="">Todos os tipos</option>
                                <option value="basic">Básicos</option>
                                <option value="controlled">Controlados</option>
                                <option value="psychotropic">Psicotrópicos</option>
                                <option value="high_cost">Alto Custo</option>
                            </select>
                        </div>
                    </div>

                    <!-- ✅ ÁREA DE RESULTADOS -->
                    <div id="searchResults">
                        <!-- Estado inicial -->
                        <div id="initialState" class="text-center py-5">
                            <i class="fas fa-pills fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Busque por medicamentos</h5>
                            <p class="text-muted mb-2">Digite o nome do medicamento no campo acima para encontrar opções disponíveis</p>
                            <div class="alert alert-warning">
                                <small><strong>Lembrete:</strong> Todos os medicamentos precisarão de configuração de controle de intervalo.</small>
                            </div>
                        </div>

                        <!-- Loading -->
                        <div id="searchLoading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Buscando...</span>
                            </div>
                            <p class="mt-2 text-muted">Buscando medicamentos...</p>
                        </div>

                        <!-- Sem resultados -->
                        <div id="noResults" class="text-center py-5" style="display: none;">
                            <i class="fas fa-search fa-2x text-muted mb-3"></i>
                            <h6 class="text-muted">Nenhum medicamento encontrado</h6>
                            <p class="text-muted mb-0">Tente buscar por outro nome ou verifique a grafia</p>
                        </div>

                        <!-- Tabela de resultados -->
                        <div id="resultsTable" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Medicamento</th>
                                            <th>Dosagem</th>
                                            <th>Forma</th>
                                            <th>Estoque</th>
                                            <th>Custo</th>
                                            <th>Controle</th>
                                            <th width="120">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="medicationsTableBody">
                                        <!-- Resultados inseridos dinamicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ✅ MODAL DE QUANTIDADE COM CÁLCULOS INTEGRADOS -->
<div class="modal fade" id="quantityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-pills me-2"></i>Definir Quantidade e Cálculos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Informações do medicamento -->
                <div class="card mb-3">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col">
                                <div class="fw-semibold" id="selectedMedicationName"></div>
                                <small class="text-muted" id="selectedMedicationDetails"></small>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-info" id="calculationStatus">
                                    <i class="fas fa-calculator me-1"></i>Verificando cálculos...
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- ✅ LADO ESQUERDO: PRESCRIÇÃO E CÁLCULOS -->
                    <div class="col-md-6">
                        <h6 class="mb-3">
                            <i class="fas fa-prescription me-2"></i>Dados da Prescrição
                        </h6>
                        
                        <!-- Dose prescrita -->
                        <div class="mb-3">
                            <label for="prescribedDose" class="form-label">Dose Prescrita:</label>
                            <div class="input-group">
                                <input type="number" id="prescribedDose" class="form-control" 
                                       placeholder="Ex: 5" step="0.1" min="0">
                                <select id="prescribedUnit" class="form-select" style="max-width: 120px;">
                                    <option value="mg">mg</option>
                                    <option value="ml">ml</option>
                                    <option value="g">g</option>
                                    <option value="mcg">mcg</option>
                                    <option value="UI">UI</option>
                                    <option value="gotas">gotas</option>
                                </select>
                            </div>
                            <div class="form-text">Dose por administração conforme prescrição</div>
                        </div>

                        <!-- Frequência -->
                        <div class="mb-3">
                            <label for="frequency" class="form-label">Frequência por dia:</label>
                            <select id="frequency" class="form-select">
                                <option value="1">1x ao dia (24/24h)</option>
                                <option value="2">2x ao dia (12/12h)</option>
                                <option value="3">3x ao dia (8/8h)</option>
                                <option value="4">4x ao dia (6/6h)</option>
                                <option value="6">6x ao dia (4/4h)</option>
                                <option value="8">8x ao dia (3/3h)</option>
                                <option value="12">12x ao dia (2/2h)</option>
                            </select>
                        </div>

                        <!-- Dias de tratamento -->
                        <div class="mb-3">
                            <label for="treatmentDays" class="form-label">Dias de tratamento:</label>
                            <div class="input-group">
                                <input type="number" id="treatmentDays" class="form-control" 
                                       value="30" min="1" max="365">
                                <span class="input-group-text">dias</span>
                            </div>
                        </div>

                        <!-- Botão calcular -->
                        <button type="button" id="calculateBtn" class="btn btn-primary w-100">
                            <i class="fas fa-calculator me-2"></i>Calcular Quantidade
                        </button>
                    </div>

                    <!-- ✅ LADO DIREITO: QUANTIDADE E RESULTADO -->
                    <div class="col-md-6">
                        <h6 class="mb-3">
                            <i class="fas fa-box me-2"></i>Quantidade a Dispensar
                        </h6>

                        <!-- Resultado do cálculo -->
                        <div id="calculationResult" class="alert alert-light mb-3" style="display: none;">
                            <h6 class="mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>Resultado do Cálculo
                            </h6>
                            <div id="calculationDetails"></div>
                        </div>

                        <!-- Quantidade manual/ajustada -->
                        <div class="mb-3">
                            <label for="medicationQuantity" class="form-label">
                                Quantidade Final <span class="text-danger">*</span>:
                            </label>
                            <div class="input-group">
                                <button type="button" class="btn btn-outline-secondary" id="decreaseQty">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" id="medicationQuantity" class="form-control text-center" 
                                       min="1" max="999" value="1" style="font-size: 1.1rem; font-weight: 600;">
                                <button type="button" class="btn btn-outline-secondary" id="increaseQty">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-box me-1"></i>
                                Estoque disponível: <span id="availableStock" class="fw-semibold"></span> unidades
                            </div>
                        </div>

                        <!-- Observações -->
                        <div class="mb-3">
                            <label for="medicationObservations" class="form-label">Observações:</label>
                            <textarea id="medicationObservations" class="form-control" rows="3" 
                                      placeholder="Instruções de uso, observações específicas..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- ✅ RESUMO EXPANDIDO -->
                <div class="bg-light p-3 rounded mt-3">
                    <h6 class="mb-2">
                        <i class="fas fa-calculator me-2"></i>Resumo da Dispensação
                    </h6>
                    <div class="row">
                        <div class="col-md-3">
                            <small class="text-muted">Quantidade:</small><br>
                            <span id="summaryQuantity" class="fw-semibold">1</span> unidades
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Custo Total:</small><br>
                            <span id="summaryTotal" class="fw-semibold text-primary">R$ 0,00</span>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Dose/Dia:</small><br>
                            <span id="summaryDailyDose" class="fw-semibold">--</span>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Duração:</small><br>
                            <span id="summaryDuration" class="fw-semibold">--</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="addToCartBtn">
                    <i class="fas fa-cart-plus me-1"></i>Adicionar ao Carrinho
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ✅ MODAL DE CONFIGURAÇÃO UNIVERSAL -->
<div class="modal fade" id="configurationModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>Configurar Controles de Intervalo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Configure o controle de intervalo para cada medicamento selecionado.
                </div>
                
                <div id="medicationConfigurations">
                    <!-- Configurações inseridas dinamicamente -->
                </div>
                
                <div class="mt-3">
                    <label class="form-label">Observações Gerais</label>
                    <textarea id="generalObservations" class="form-control" rows="3" 
                              placeholder="Observações sobre a dispensação..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" id="confirmDispensation">
                    <i class="fas fa-check me-2"></i>Confirmar Dispensação
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ✅ MODAL DE MEDICAMENTOS BLOQUEADOS -->
<div class="modal fade" id="blockedMedicationsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Medicamentos Bloqueados
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Atenção:</strong> Alguns medicamentos não podem ser dispensados no momento.
                </div>
                
                <div id="blockedMedicationsList">
                    <!-- Lista inserida dinamicamente -->
                </div>
                
                <div id="forceReleaseSection" style="display: none;">
                    <hr>
                    <h6>Liberação Antecipada</h6>
                    <div class="mb-3">
                        <label class="form-label">
                            <strong>Justificativa <span class="text-danger">*</span></strong>
                        </label>
                        <textarea id="forceReleaseJustification" 
                                  class="form-control" 
                                  rows="4" 
                                  placeholder="Descreva detalhadamente o motivo da liberação antecipada..."
                                  required></textarea>
                        <div class="form-text">Mínimo 10 caracteres</div>
                    </div>
                    
                    <div id="forceReleaseError" class="alert alert-danger d-none"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="configureIntervalsBtn" style="display: none;">
                    <i class="fas fa-arrow-left me-2"></i>Voltar e Configurar
                </button>
                <button type="button" class="btn btn-warning" id="authorizeForceRelease" style="display: none;">
                    <i class="fas fa-unlock me-2"></i>Autorizar Liberação Antecipada
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.avatar-lg {
    width: 48px;
    height: 48px;
    font-size: 18px;
    font-weight: 600;
}

.text-sm {
    font-size: 0.875rem;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
}

#medicationsTableBody tr {
    cursor: pointer;
}

#medicationsTableBody tr:hover {
    background-color: var(--bs-gray-100);
}

.interval-config-card {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.interval-config-header {
    background-color: #f8f9fa;
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    border-radius: 0.375rem 0.375rem 0 0;
}

.interval-config-body {
    padding: 1rem;
}

.quick-interval-btn {
    margin: 0.125rem;
}

.medication-status-badge {
    font-size: 0.75rem;
}

.control-status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
}

.control-status-indicator.status-new {
    background-color: #ffc107;
}

.control-status-indicator.status-blocked {
    background-color: #dc3545;
}

.control-status-indicator.status-released {
    background-color: #28a745;
}

/* ✅ Estilos para o modal de quantidade */
#medicationQuantity {
    border-left: none !important;
    border-right: none !important;
}

#decreaseQty, #increaseQty {
    border-radius: 0.375rem !important;
}

#decreaseQty {
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
}

#increaseQty {
    border-top-left-radius: 0 !important;
    border-bottom-left-radius: 0 !important;
}

.cart-item-controls {
    min-width: 80px;
}

.loading-overlay {
    position: relative;
}

.loading-overlay::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    z-index: 10;
}

.loading-overlay::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 2rem;
    height: 2rem;
    border: 0.25rem solid #f3f3f3;
    border-top: 0.25rem solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    z-index: 11;
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // ✅ DADOS DO PACIENTE
    const patient = {
        id: {{ patient.id }},
        full_name: "{{ patient.full_name }}",
        cpf: "{{ patient.cpf }}"
    };
    
    let cart = [];
    let selectedMedicationsData = [];
    let searchTimeout = null;
    let blockedMedicationsData = [];
    let selectedMedication = null;
    let lastCalculationResult = null;  // ✅ NOVO: Último resultado de cálculo
    
    // ✅ CARREGAR CONTROLES ATIVOS AO INICIAR
    loadActiveControls();
    
    // ✅ BUSCA DE MEDICAMENTOS COM DEBOUNCE
    $('#medicationSearch').on('input', function() {
        const searchTerm = $(this).val().trim();
        
        clearTimeout(searchTimeout);
        
        if (searchTerm.length < 3) {
            showInitialState();
            return;
        }
        
        searchTimeout = setTimeout(() => {
            searchMedications(searchTerm);
        }, 500);
    });
    
    // ✅ FILTRO POR TIPO
    $('#medicationType').on('change', function() {
        const searchTerm = $('#medicationSearch').val().trim();
        if (searchTerm.length >= 3) {
            searchMedications(searchTerm);
        }
    });
    
    // ✅ CONTROLES DO MODAL DE QUANTIDADE
    $('#decreaseQty').on('click', function() {
        const current = parseInt($('#medicationQuantity').val());
        if (current > 1) {
            $('#medicationQuantity').val(current - 1);
            updateQuantitySummary();
        }
    });
    
    $('#increaseQty').on('click', function() {
        const current = parseInt($('#medicationQuantity').val());
        const max = parseInt($('#medicationQuantity').attr('max'));
        if (current < max) {
            $('#medicationQuantity').val(current + 1);
            updateQuantitySummary();
        }
    });
    
    $('#medicationQuantity').on('input change', function() {
        updateQuantitySummary();
    });
    
    $('#addToCartBtn').on('click', function() {
        addMedicationToCart();
    });
    
    // ✅ NOVOS CONTROLES DE CÁLCULO
    $('#prescribedDose, #frequency, #treatmentDays').on('change input', function() {
        updateQuantitySummary();
    });
    
    $('#calculateBtn').on('click', function() {
        const prescribedDose = parseFloat($('#prescribedDose').val());
        const prescribedUnit = $('#prescribedUnit').val();
        const frequency = parseInt($('#frequency').val());
        const treatmentDays = parseInt($('#treatmentDays').val());
        
        // Validações
        if (!prescribedDose || prescribedDose <= 0) {
            showAlert('Digite uma dose prescrita válida!', 'warning');
            $('#prescribedDose').focus();
            return;
        }
        
        if (!frequency || frequency <= 0) {
            showAlert('Selecione a frequência de uso!', 'warning');
            return;
        }
        
        if (!treatmentDays || treatmentDays <= 0) {
            showAlert('Digite os dias de tratamento!', 'warning');
            $('#treatmentDays').focus();
            return;
        }
        
        // Iniciar cálculo
        performCalculation(prescribedDose, prescribedUnit, frequency, treatmentDays);
    });
    
    // ✅ CARREGAR CONTROLES ATIVOS VIA AJAX
    function loadActiveControls() {
        $.ajax({
            url: `/api/patients/${patient.id}/medication-controls`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    displayActiveControls(response.controls || []);
                } else {
                    showControlsError();
                }
            },
            error: function() {
                showControlsError();
            }
        });
    }
    
    // ✅ EXIBIR ERRO NO CARREGAMENTO DE CONTROLES
    function showControlsError() {
        $('#activeControlsList').html(`
            <div class="text-center text-muted py-3">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p class="mb-0">Erro ao carregar controles</p>
            </div>
        `);
    }
    
    // ✅ EXIBIR CONTROLES ATIVOS
    function displayActiveControls(controls) {
        if (controls.length === 0) {
            $('#activeControlsList').html(`
                <div class="text-center text-muted py-3">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <p class="mb-0">Nenhum controle ativo</p>
                    <small>Primeiras dispensações criarão controles</small>
                </div>
            `);
            return;
        }
        
        let html = '<div class="list-group list-group-flush">';
        
        controls.forEach(control => {
            const statusClass = control.can_dispense_today ? 'success' : 'warning';
            const statusText = control.can_dispense_today ? 'Liberado' : `${control.days_until_next_allowed} dias`;
            
            html += `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${control.medication_name}</h6>
                            <p class="mb-1 small">
                                Última: ${control.last_dispensation_date}
                            </p>
                            <small class="text-muted">
                                Próxima: ${control.next_allowed_date}
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-${statusClass}">${statusText}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        $('#activeControlsList').html(html);
    }
    
    // ✅ FUNÇÃO DE BUSCA
    function searchMedications(searchTerm) {
        showLoading();
        
        const medicationType = $('#medicationType').val();
        
        $.ajax({
            url: '/api/medications/search',
            method: 'GET',
            data: {
                q: searchTerm,
                type: medicationType,
                patient_id: patient.id
            },
            success: function(medications) {
                displayResults(medications);
            },
            error: function(xhr) {
                console.error('Erro na busca:', xhr);
                showError('Erro ao buscar medicamentos');
            }
        });
    }
    
    // ✅ EXIBIR RESULTADOS
    function displayResults(medications) {
        if (medications.length === 0) {
            showNoResults();
            return;
        }
        
        let html = '';
        
        medications.forEach(med => {
            // Status do estoque
            let stockBadge = '';
            if (med.current_stock <= 0) {
                stockBadge = '<span class="badge bg-danger">0</span>';
            } else if (med.current_stock <= med.minimum_stock) {
                stockBadge = `<span class="badge bg-warning">${med.current_stock}</span>`;
            } else {
                stockBadge = `<span class="badge bg-success">${med.current_stock}</span>`;
            }
            
            // Status do controle - Universal
            let controlBadge = '<span class="badge bg-info">Controle Obrigatório</span>';
            
            // Botão de ação
            let actionButton = '';
            if (med.current_stock > 0) {
                actionButton = `
                    <button type="button" class="btn btn-sm btn-outline-primary add-medication" 
                            data-medication='${JSON.stringify(med).replace(/'/g, "&#39;")}' 
                            title="Adicionar medicamento">
                        <i class="fas fa-plus"></i>
                    </button>
                `;
            } else {
                actionButton = `
                    <button type="button" class="btn btn-sm btn-outline-secondary" disabled 
                            title="Sem estoque">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            }
            
            html += `
                <tr data-medication-id="${med.id}">
                    <td>
                        <div>
                            <div class="fw-semibold">${med.commercial_name}</div>
                            <small class="text-muted">${med.generic_name || '--'}</small>
                        </div>
                    </td>
                    <td>${med.dosage || '--'}</td>
                    <td>
                        <span class="badge bg-light text-dark">${med.pharmaceutical_form || '--'}</span>
                    </td>
                    <td>${stockBadge}</td>
                    <td>R$ ${(med.unit_cost || 0).toFixed(2)}</td>
                    <td>${controlBadge}</td>
                    <td>${actionButton}</td>
                </tr>
            `;
        });
        
        $('#medicationsTableBody').html(html);
        showResults();
        
        // Event listeners
        $('.add-medication').off('click').on('click', handleAddMedication);
    }
    
    // ✅ PREPARAR ADIÇÃO DE MEDICAMENTO (ABRIR MODAL DE QUANTIDADE)
    function handleAddMedication() {
        const medicationData = $(this).data('medication');
        
        selectedMedication = {
            id: medicationData.id,
            name: medicationData.commercial_name,
            generic_name: medicationData.generic_name || '',
            dosage: medicationData.dosage || '',
            pharmaceutical_form: medicationData.pharmaceutical_form || '',
            cost: medicationData.unit_cost || 0,
            stock: medicationData.current_stock,
            has_calculation_config: medicationData.has_calculation_config || false  // ✅ NOVO
        };
        
        showQuantityModal();
    }
    
    // ✅ MOSTRAR MODAL DE QUANTIDADE COM CÁLCULOS
    function showQuantityModal() {
        // Preencher dados do medicamento
        $('#selectedMedicationName').text(selectedMedication.name);
        
        const details = [];
        if (selectedMedication.generic_name) details.push(selectedMedication.generic_name);
        if (selectedMedication.dosage) details.push(selectedMedication.dosage);
        if (selectedMedication.pharmaceutical_form) details.push(selectedMedication.pharmaceutical_form);
        
        $('#selectedMedicationDetails').text(details.join(' • '));
        $('#availableStock').text(selectedMedication.stock);
        
        // Resetar valores
        $('#medicationQuantity').val(1).attr('max', selectedMedication.stock);
        $('#medicationObservations').val('');
        
        // ✅ NOVO: Resetar campos de cálculo
        $('#prescribedDose').val('');
        $('#prescribedUnit').val('mg');
        $('#frequency').val('2');
        $('#treatmentDays').val('30');
        $('#calculationResult').hide();
        lastCalculationResult = null;
        
        // ✅ NOVO: Verificar configuração de cálculos
        checkMedicationCalculationConfig();
        
        // Atualizar resumo
        updateQuantitySummary();
        
        $('#quantityModal').modal('show');
        $('#prescribedDose').focus();  // ✅ Focar no campo de dose
    }
    
    // ✅ NOVA FUNÇÃO: Verificar configuração de cálculos
    function checkMedicationCalculationConfig() {
        // ✅ USAR DADOS QUE JÁ VIERAM DA BUSCA
        if (selectedMedication.has_calculation_config) {
            $('#calculationStatus').html('<i class="fas fa-check-circle text-success me-1"></i>Cálculos disponíveis')
                .removeClass('bg-info').addClass('bg-success');
        } else {
            $('#calculationStatus').html('<i class="fas fa-info-circle me-1"></i>Cálculo manual')
                .removeClass('bg-info').addClass('bg-warning');
        }
    }
    
    // ✅ NOVA FUNÇÃO: Executar cálculo
    function performCalculation(prescribedDose, prescribedUnit, frequency, treatmentDays) {
        const $btn = $('#calculateBtn');
        const originalText = $btn.html();
        
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Calculando...');
        
        const calculationData = {
            prescribed_dose: prescribedDose,
            prescribed_unit: prescribedUnit,
            frequency: frequency,
            treatment_days: treatmentDays
        };
        
        $.ajax({
            url: `/dispensation/calculate/${patient.id}/${selectedMedication.id}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(calculationData),
            success: function(response) {
                if (response.success) {
                    lastCalculationResult = response;
                    displayCalculationResult(response);
                    
                    // ✅ Atualizar quantidade automaticamente
                    if (response.recommended_quantity) {
                        const roundedQty = Math.ceil(response.recommended_quantity);
                        $('#medicationQuantity').val(roundedQty);
                        updateQuantitySummary();
                    }
                } else {
                    showAlert('Erro no cálculo: ' + response.error, 'error');
                    showManualCalculationFallback();
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                if (response && response.error) {
                    showAlert('Erro no cálculo: ' + response.error, 'error');
                } else {
                    showAlert('Erro interno no cálculo. Use quantidade manual.', 'error');
                }
                showManualCalculationFallback();
            },
            complete: function() {
                $btn.prop('disabled', false).html(originalText);
            }
        });
    }
    
    // ✅ NOVA FUNÇÃO: Exibir resultado do cálculo
    function displayCalculationResult(result) {
        let html = '<div class="row g-2 small">';
        
        // Quantidade recomendada
        if (result.recommended_quantity) {
            html += `
                <div class="col-6">
                    <strong>Quantidade Calculada:</strong><br>
                    <span class="text-primary">${Math.ceil(result.recommended_quantity)} unidades</span>
                </div>
            `;
        }
        
        // Duração real
        if (result.actual_duration) {
            html += `
                <div class="col-6">
                    <strong>Duração Real:</strong><br>
                    <span>${result.actual_duration} dias</span>
                </div>
            `;
        }
        
        // Dose por administração
        if (result.volume_per_dose) {
            html += `
                <div class="col-6">
                    <strong>Volume por Dose:</strong><br>
                    <span>${result.volume_per_dose} ${result.volume_unit || 'ml'}</span>
                </div>
            `;
        }
        
        // Dose diária total
        if (result.daily_volume) {
            html += `
                <div class="col-6">
                    <strong>Volume Diário:</strong><br>
                    <span>${result.daily_volume} ${result.volume_unit || 'ml'}</span>
                </div>
            `;
        }
        
        // Conversões (se houver)
        if (result.conversions && result.conversions.length > 0) {
            html += '<div class="col-12"><hr class="my-2"><small class="text-muted"><strong>Conversões:</strong></small>';
            result.conversions.forEach(conv => {
                html += `<br><small>${conv}</small>`;
            });
            html += '</div>';
        }
        
        // Observações técnicas
        if (result.notes && result.notes.length > 0) {
            html += '<div class="col-12"><hr class="my-2"><small class="text-info"><strong>Observações:</strong></small>';
            result.notes.forEach(note => {
                html += `<br><small class="text-muted">${note}</small>`;
            });
            html += '</div>';
        }
        
        html += '</div>';
        
        $('#calculationDetails').html(html);
        $('#calculationResult').show();
    }
    
    // ✅ NOVA FUNÇÃO: Fallback para cálculo manual
    function showManualCalculationFallback() {
        $('#calculationDetails').html(`
            <div class="text-center text-muted">
                <i class="fas fa-calculator fa-2x mb-2"></i>
                <p class="mb-0">Cálculo automático indisponível</p>
                <small>Configure a quantidade manualmente</small>
            </div>
        `);
        $('#calculationResult').show();
    }
    
    // ✅ ATUALIZAR RESUMO DA QUANTIDADE (EXPANDIDO)
    function updateQuantitySummary() {
        const quantity = parseInt($('#medicationQuantity').val()) || 1;
        const total = selectedMedication.cost * quantity;
        
        $('#summaryQuantity').text(quantity);
        $('#summaryTotal').text(`R$ ${total.toFixed(2)}`);
        
        // ✅ NOVO: Atualizar informações de dosagem
        const prescribedDose = parseFloat($('#prescribedDose').val()) || 0;
        const frequency = parseInt($('#frequency').val()) || 1;
        const treatmentDays = parseInt($('#treatmentDays').val()) || 1;
        
        if (prescribedDose > 0) {
            const dailyDose = prescribedDose * frequency;
            $('#summaryDailyDose').text(`${dailyDose} ${$('#prescribedUnit').val()}`);
            $('#summaryDuration').text(`${treatmentDays} dias`);
        } else {
            $('#summaryDailyDose').text('--');
            $('#summaryDuration').text('--');
        }
    }
    
    // ✅ ADICIONAR MEDICAMENTO AO CARRINHO (COM DADOS DE CÁLCULO)
    function addMedicationToCart() {
        const quantity = parseInt($('#medicationQuantity').val());
        const observations = $('#medicationObservations').val().trim();
        
        // Validar quantidade
        if (quantity < 1 || quantity > selectedMedication.stock) {
            showAlert(`Quantidade deve ser entre 1 e ${selectedMedication.stock}!`, 'warning');
            return;
        }
        
        // ✅ NOVO: Coletar dados de cálculo
        const calculationData = {
            prescribed_dose: parseFloat($('#prescribedDose').val()) || null,
            prescribed_unit: $('#prescribedUnit').val(),
            frequency: parseInt($('#frequency').val()) || null,
            treatment_days: parseInt($('#treatmentDays').val()) || null,
            has_calculation: lastCalculationResult !== null,
            calculation_result: lastCalculationResult
        };
        
        // Verificar se já está no carrinho
        const existingIndex = cart.findIndex(item => item.id === selectedMedication.id);
        
        if (existingIndex >= 0) {
            // Atualizar item existente
            cart[existingIndex].quantity += quantity;
            cart[existingIndex].calculation_data = calculationData;  // ✅ NOVO
            if (observations) {
                cart[existingIndex].observations = observations;
            }
            showAlert(`Quantidade atualizada para ${cart[existingIndex].quantity} unidades!`, 'success');
        } else {
            // Adicionar novo item
            cart.push({
                id: selectedMedication.id,
                name: selectedMedication.name,
                cost: selectedMedication.cost,
                stock: selectedMedication.stock,
                quantity: quantity,
                observations: observations,
                interval_days: 30,  // Padrão
                calculation_data: calculationData  // ✅ NOVO
            });
            showAlert('Medicamento adicionado ao carrinho!', 'success');
        }
        
        updateCart();
        $('#quantityModal').modal('hide');
    }
    
    // ✅ ATUALIZAR CARRINHO (COM INFORMAÇÕES DE CÁLCULO)
    function updateCart() {
        const cartItems = $('#cartItems');
        const cartCount = $('#cartCount');
        const cartTotal = $('#cartTotal');
        const cartFooter = $('#cartFooter');
        
        if (cart.length === 0) {
            cartItems.html(`
                <div class="text-center text-muted py-3">
                    <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                    <p class="mb-0">Nenhum medicamento selecionado</p>
                    <small>Clique no botão + para adicionar medicamentos</small>
                </div>
            `);
            cartFooter.hide();
            cartCount.text('0');
            return;
        }
        
        let html = '<div class="list-group list-group-flush">';
        let total = 0;
        
        cart.forEach((item, index) => {
            const itemTotal = item.cost * item.quantity;
            total += itemTotal;
            
            // ✅ NOVO: Informações de cálculo
            let calculationInfo = '';
            if (item.calculation_data && item.calculation_data.has_calculation) {
                const calc = item.calculation_data;
                calculationInfo = `
                    <br><small class="text-success">
                        <i class="fas fa-calculator me-1"></i>
                        ${calc.prescribed_dose} ${calc.prescribed_unit} • ${calc.frequency}x/dia • ${calc.treatment_days} dias
                    </small>
                `;
            }
            
            html += `
                <div class="list-group-item px-0">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="fw-semibold">
                                <i class="fas fa-pills text-primary me-1"></i> ${item.name}
                            </div>
                            <small class="text-muted">
                                ${item.quantity} × R$ ${item.cost.toFixed(2)} = R$ ${itemTotal.toFixed(2)}
                            </small>
                            ${calculationInfo}
                            ${item.observations ? `<br><small class="text-info"><i class="fas fa-comment me-1"></i>${item.observations}</small>` : ''}
                            <br><small class="text-warning">
                                <i class="fas fa-clock me-1"></i>Controle obrigatório
                            </small>
                        </div>
                        <div class="cart-item-controls">
                            <div class="btn-group btn-group-sm d-flex">
                                <button type="button" class="btn btn-outline-secondary decrease-cart-qty" 
                                        data-index="${index}" title="Diminuir quantidade">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary edit-cart-item" 
                                        data-index="${index}" title="Editar item">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger remove-cart-item" 
                                        data-index="${index}" title="Remover item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        cartItems.html(html);
        cartCount.text(cart.length);
        cartTotal.text('R$ ' + total.toFixed(2));
        cartFooter.show();
        
        // Event listeners para botões do carrinho
        $('.decrease-cart-qty').off('click').on('click', function() {
            const index = $(this).data('index');
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
                updateCart();
            } else {
                cart.splice(index, 1);
                updateCart();
                showAlert('Medicamento removido do carrinho.', 'info');
            }
        });
        
        $('.edit-cart-item').off('click').on('click', function() {
            const index = $(this).data('index');
            editCartItem(index);
        });
        
        $('.remove-cart-item').off('click').on('click', function() {
            const index = $(this).data('index');
            cart.splice(index, 1);
            updateCart();
            showAlert('Medicamento removido do carrinho.', 'info');
        });
    }
    
    // ✅ EDITAR ITEM DO CARRINHO
    function editCartItem(index) {
        const item = cart[index];
        
        selectedMedication = {
            id: item.id,
            name: item.name,
            cost: item.cost,
            stock: item.stock,
            has_calculation_config: item.calculation_data && item.calculation_data.has_calculation
        };
        
        // Preencher modal com dados atuais
        $('#selectedMedicationName').text(item.name);
        $('#selectedMedicationDetails').text('Editando item do carrinho');
        $('#availableStock').text(item.stock);
        $('#medicationQuantity').val(item.quantity).attr('max', item.stock);
        $('#medicationObservations').val(item.observations || '');
        
        // ✅ NOVO: Preencher dados de cálculo se existirem
        if (item.calculation_data) {
            $('#prescribedDose').val(item.calculation_data.prescribed_dose || '');
            $('#prescribedUnit').val(item.calculation_data.prescribed_unit || 'mg');
            $('#frequency').val(item.calculation_data.frequency || 2);
            $('#treatmentDays').val(item.calculation_data.treatment_days || 30);
            lastCalculationResult = item.calculation_data.calculation_result;
            
            if (lastCalculationResult) {
                displayCalculationResult(lastCalculationResult);
            }
        }
        
        // Verificar configuração
        checkMedicationCalculationConfig();
        
        // Atualizar resumo
        updateQuantitySummary();
        
        // Alterar comportamento do botão
        $('#addToCartBtn').off('click').text('Atualizar Item').on('click', function() {
            updateCartItem(index);
        });
        
        $('#quantityModal').modal('show');
    }
    
    // ✅ ATUALIZAR ITEM DO CARRINHO
    function updateCartItem(index) {
        const quantity = parseInt($('#medicationQuantity').val());
        const observations = $('#medicationObservations').val().trim();
        
        if (quantity < 1 || quantity > selectedMedication.stock) {
            showAlert(`Quantidade deve ser entre 1 e ${selectedMedication.stock}!`, 'warning');
            return;
        }
        
        // ✅ NOVO: Atualizar dados de cálculo
        const calculationData = {
            prescribed_dose: parseFloat($('#prescribedDose').val()) || null,
            prescribed_unit: $('#prescribedUnit').val(),
            frequency: parseInt($('#frequency').val()) || null,
            treatment_days: parseInt($('#treatmentDays').val()) || null,
            has_calculation: lastCalculationResult !== null,
            calculation_result: lastCalculationResult
        };
        
        cart[index].quantity = quantity;
        cart[index].observations = observations;
        cart[index].calculation_data = calculationData;  // ✅ NOVO
        
        updateCart();
        $('#quantityModal').modal('hide');
        
        // Restaurar comportamento original do botão
        $('#addToCartBtn').off('click').text('Adicionar ao Carrinho').on('click', function() {
            addMedicationToCart();
        });
        
        showAlert('Item atualizado!', 'success');
    }
    
    // ✅ PROCEDER PARA CONFIGURAÇÃO
    $('#proceedToConfiguration').on('click', function() {
        if (cart.length === 0) {
            showAlert('Adicione pelo menos um medicamento!', 'warning');
            return;
        }
        
        showConfigurationModal();
    });
    
    // ✅ MODAL DE CONFIGURAÇÃO
    function showConfigurationModal() {
        selectedMedicationsData = cart.map(item => ({
            ...item,
            interval_control: {
                enabled: true,
                interval_days: 30,
                next_allowed_date: getDefaultNextDate(30),
                justification: '',
                category: 'standard'
            }
        }));
        
        generateConfigurationForms();
        $('#configurationModal').modal('show');
    }
    
    // ✅ GERAR FORMULÁRIOS DE CONFIGURAÇÃO
    function generateConfigurationForms() {
        let html = '';
        
        selectedMedicationsData.forEach((med, index) => {
            // ✅ NOVO: Mostrar informações de cálculo se existirem
            let calculationInfo = '';
            if (med.calculation_data && med.calculation_data.has_calculation) {
                const calc = med.calculation_data;
                calculationInfo = `
                    <div class="alert alert-info alert-sm mt-2">
                        <small>
                            <i class="fas fa-calculator me-1"></i>
                            <strong>Cálculo:</strong> ${calc.prescribed_dose} ${calc.prescribed_unit} • ${calc.frequency}x/dia • ${calc.treatment_days} dias
                        </small>
                    </div>
                `;
            }
            
            html += `
                <div class="interval-config-card">
                    <div class="interval-config-header">
                        <h6 class="mb-0">
                            <i class="fas fa-pills me-2"></i>${med.name}
                            <span class="badge bg-primary ms-2">${med.quantity} unidades</span>
                            <span class="badge bg-success ms-1">R$ ${(med.cost * med.quantity).toFixed(2)}</span>
                        </h6>
                        ${med.observations ? `<small class="text-muted mt-1 d-block"><i class="fas fa-comment me-1"></i>${med.observations}</small>` : ''}
                        ${calculationInfo}
                    </div>
                    <div class="interval-config-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Intervalo (dias) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control interval-days" 
                                       data-index="${index}" min="1" max="365" 
                                       value="${med.interval_control.interval_days}" required>
                                <div class="form-text">Tempo entre dispensações</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Próxima liberação <span class="text-danger">*</span></label>
                                <input type="date" class="form-control next-date" 
                                       data-index="${index}" value="${med.interval_control.next_allowed_date}" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Categoria</label>
                                <select class="form-control interval-category" data-index="${index}">
                                    <option value="standard">Padrão</option>
                                    <option value="controlled">Controlado</option>
                                    <option value="psychotropic">Psicotrópico</option>
                                    <option value="high_cost">Alto Custo</option>
                                    <option value="antibiotic">Antibiótico</option>
                                    <option value="chronic">Uso Contínuo</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label">Justificativa do Controle</label>
                            <textarea class="form-control interval-justification" data-index="${index}" 
                                      rows="2" placeholder="Motivo do controle (ex: tratamento contínuo, uso controlado, etc.)"></textarea>
                        </div>
                        
                        <!-- Botões de intervalo rápido -->
                        <div class="mt-2">
                            <small class="text-muted">Intervalos rápidos:</small><br>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary quick-interval-btn" 
                                        data-index="${index}" data-days="7">7 dias</button>
                                <button type="button" class="btn btn-outline-secondary quick-interval-btn" 
                                        data-index="${index}" data-days="15">15 dias</button>
                                <button type="button" class="btn btn-outline-primary quick-interval-btn" 
                                        data-index="${index}" data-days="30">30 dias</button>
                                <button type="button" class="btn btn-outline-secondary quick-interval-btn" 
                                        data-index="${index}" data-days="60">60 dias</button>
                                <button type="button" class="btn btn-outline-secondary quick-interval-btn" 
                                        data-index="${index}" data-days="90">90 dias</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        $('#medicationConfigurations').html(html);
        
        // Event listeners
        $('.quick-interval-btn').on('click', function() {
            const index = $(this).data('index');
            const days = $(this).data('days');
            setQuickInterval(index, days);
        });
        
        $('.interval-days').on('change', function() {
            const index = $(this).data('index');
            const days = parseInt($(this).val());
            updateNextDate(index, days);
        });
    }
    
    // ✅ FUNÇÕES AUXILIARES
    function setQuickInterval(index, days) {
        $(`.interval-days[data-index="${index}"]`).val(days);
        updateNextDate(index, days);
    }
    
    function updateNextDate(index, days) {
        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + days);
        $(`.next-date[data-index="${index}"]`).val(nextDate.toISOString().split('T')[0]);
    }
    
    function getDefaultNextDate(days) {
        const date = new Date();
        date.setDate(date.getDate() + days);
        return date.toISOString().split('T')[0];
    }
    
    // ✅ CONFIRMAR DISPENSAÇÃO
    $('#confirmDispensation').on('click', function() {
        if (!validateConfigurations()) {
            return;
        }
        
        // Coletar dados finais
        const dispensationData = {
            patient_id: patient.id,
            general_observations: $('#generalObservations').val(),
            medications: collectMedicationData()
        };
        
        processDispensation(dispensationData);
    });
    
    // ✅ VALIDAR CONFIGURAÇÕES
    function validateConfigurations() {
        let hasErrors = false;
        
        selectedMedicationsData.forEach((med, index) => {
            const days = $(`.interval-days[data-index="${index}"]`).val();
            const nextDate = $(`.next-date[data-index="${index}"]`).val();
            
            if (!days || days < 1) {
                showAlert(`${med.name}: Intervalo deve ser pelo menos 1 dia.`, 'warning');
                hasErrors = true;
            }
            
            if (!nextDate) {
                showAlert(`${med.name}: Data da próxima liberação é obrigatória.`, 'warning');
                hasErrors = true;
            }
            
            const selectedDate = new Date(nextDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate <= today) {
                showAlert(`${med.name}: Data da próxima liberação deve ser futura.`, 'warning');
                hasErrors = true;
            }
        });
        
        return !hasErrors;
    }
    
    // ✅ COLETAR DADOS FINAIS
    function collectMedicationData() {
        return selectedMedicationsData.map((med, index) => ({
            medication_id: med.id,
            quantity: med.quantity,
            observations: med.observations || '',
            interval_control: {
                enabled: true,
                interval_days: parseInt($(`.interval-days[data-index="${index}"]`).val()),
                next_allowed_date: $(`.next-date[data-index="${index}"]`).val(),
                justification: $(`.interval-justification[data-index="${index}"]`).val() || 
                             `Controle padrão - categoria: ${$(`.interval-category[data-index="${index}"]`).val()}`,
                category: $(`.interval-category[data-index="${index}"]`).val()
            }
        }));
    }
    
    // ✅ PROCESSAR DISPENSAÇÃO
    function processDispensation(dispensationData, forceRelease = false, forceJustification = '') {
        const $btn = $('#confirmDispensation');
        const originalText = $btn.html();
        
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Processando...');
        
        // Adicionar parâmetros de força se necessário
        if (forceRelease) {
            dispensationData.force_release = true;
            dispensationData.force_justification = forceJustification;
        }
        
        $.ajax({
            url: '/dispensation/create',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dispensationData),
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    
                    // ✅ USAR URL DE REDIRECIONAMENTO DO BACKEND
                    setTimeout(() => {
                        window.location.href = response.redirect_url || '/dispensation';
                    }, 2000);
                } else {
                    showAlert('Erro na dispensação: ' + response.error, 'error');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                
                if (response && response.blocked_medications) {
                    // Medicamentos bloqueados
                    $('#configurationModal').modal('hide');
                    showBlockedMedicationsModal(response.blocked_medications, dispensationData);
                } else {
                    showAlert('Erro interno do servidor', 'error');
                }
            },
            complete: function() {
                $btn.prop('disabled', false).html(originalText);
            }
        });
    }
    
    // ✅ MODAL DE MEDICAMENTOS BLOQUEADOS
    function showBlockedMedicationsModal(blockedMedications, originalData) {
        blockedMedicationsData = blockedMedications;
        
        let html = '';
        let hasConfigurationNeeded = false;
        let hasCarencyBlocked = false;
        
        blockedMedications.forEach(med => {
            if (med.requires_configuration) {
                hasConfigurationNeeded = true;
                html += `
                    <div class="alert alert-danger border-start border-danger border-3">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <h6 class="mb-1">${med.name}</h6>
                                <small class="text-danger">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    Controle de intervalo obrigatório não configurado
                                </small>
                                ${med.is_first_dispensation ? '<br><small class="text-muted">Primeira dispensação - configure o intervalo</small>' : ''}
                            </div>
                            <div class="col-4 text-end">
                                <span class="badge bg-danger">Configuração Necessária</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                hasCarencyBlocked = true;
                html += `
                    <div class="alert alert-warning border-start border-warning border-3">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <h6 class="mb-1">${med.name}</h6>
                                <small class="text-muted">Em carência - aguarde ${med.days_remaining} dias</small>
                                <br><small class="text-info">Intervalo configurado: ${med.interval_days || 'N/A'} dias</small>
                                ${med.last_dispensation ? `<br><small class="text-muted">Última: ${med.last_dispensation}</small>` : ''}
                            </div>
                            <div class="col-4 text-end">
                                <small class="text-muted">Próxima liberação:</small><br>
                                <span class="badge bg-warning text-dark">${med.next_date}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        $('#blockedMedicationsList').html(html);
        $('#forceReleaseJustification').val('');
        $('#forceReleaseError').addClass('d-none');
        
        // Configurar botões baseado no tipo de bloqueio
        if (hasConfigurationNeeded) {
            $('#forceReleaseSection').hide();
            $('#configureIntervalsBtn').show();
            $('#authorizeForceRelease').hide();
        } else if (hasCarencyBlocked) {
            $('#forceReleaseSection').show();
            $('#configureIntervalsBtn').hide();
            $('#authorizeForceRelease').show();
        }
        
        // Armazenar dados para processamento posterior
        $('#blockedMedicationsModal').data('originalData', originalData);
        
        $('#blockedMedicationsModal').modal('show');
    }
    
    // ✅ VOLTAR PARA CONFIGURAÇÃO
    $('#configureIntervalsBtn').on('click', function() {
        $('#blockedMedicationsModal').modal('hide');
        $('#configurationModal').modal('show');
    });
    
    // ✅ AUTORIZAR LIBERAÇÃO ANTECIPADA
    $('#authorizeForceRelease').on('click', function() {
        const justification = $('#forceReleaseJustification').val().trim();
        const errorDiv = $('#forceReleaseError');
        
        if (!justification || justification.length < 10) {
            errorDiv.text('Justificativa deve ter pelo menos 10 caracteres').removeClass('d-none');
            return;
        }
        
        errorDiv.addClass('d-none');
        
        const originalData = $('#blockedMedicationsModal').data('originalData');
        
        $('#blockedMedicationsModal').modal('hide');
        processDispensation(originalData, true, justification);
    });
    
    // ✅ FUNÇÕES DE ESTADO DA INTERFACE
    function showInitialState() {
        $('#searchResults > div').hide();
        $('#initialState').show();
    }
    
    function showLoading() {
        $('#searchResults > div').hide();
        $('#searchLoading').show();
    }
    
    function showNoResults() {
        $('#searchResults > div').hide();
        $('#noResults').show();
    }
    
    function showResults() {
        $('#searchResults > div').hide();
        $('#resultsTable').show();
    }
    
    function showError(message) {
        $('#searchResults').html(`
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                <h6 class="text-danger">${message}</h6>
            </div>
        `);
    }
    
    // ✅ FUNÇÃO PARA ALERTAS
    function showAlert(message, type = 'info') {
        const alertClass = {
            'success': 'alert-success',
            'warning': 'alert-warning', 
            'danger': 'alert-danger',
            'error': 'alert-danger',
            'info': 'alert-info'
        }[type] || 'alert-info';
        
        const alert = $(`
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(alert);
        
        setTimeout(() => {
            alert.fadeOut(() => alert.remove());
        }, 6000);
    }
    
    // ✅ CSRF TOKEN
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", $('meta[name=csrf-token]').attr('content'));
            }
        }
    });
});
</script>
{% endblock %}